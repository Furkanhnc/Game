<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Neon Block Master: Strateji ve Zeka Oyunu | Play Free</title>
    
    <meta name="description" content="En iyi neon blok yerle≈ütirme ve bulmaca oyunu. Strateji geli≈ütir, bloklarƒ± patlat, level atla ve yeteneklerini kullan. @frkhnci tarafƒ±ndan geli≈ütirilen √ºcretsiz HTML5 zeka oyunu.">
    <meta name="keywords" content="blok oyunu, block puzzle, neon oyun, tetris benzeri, zeka oyunu, strateji, html5 oyun, √ºcretsiz oyun, brain teaser, @frkhnci, level sistemi, reroll, smash">
    <meta name="author" content="Furkan Hanci (@frkhnci)">
    <meta name="robots" content="index, follow">
    
    <meta property="og:title" content="Neon Block Master - Zeka ve Strateji">
    <meta property="og:description" content="Bu oyunda sadece parmaklarƒ±n deƒüil, beynin de √ßalƒ±≈ümalƒ±. Rekorunu kƒ±rabilir misin?">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.instagram.com/frkhnci/">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;700&display=swap');

        :root {
            --bg-color: #050508;
            --panel-bg: rgba(20, 20, 30, 0.95);
            --accent: #00f3ff;
            --danger: #ff0055;
            --text-color: #fff;
            --energy-col: #ffcc00;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow: hidden;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            transition: background-color 1s ease; /* Arka plan renk ge√ßi≈üi */
        }

        /* --- BACKGROUND FX --- */
        #bg-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.3;
        }

        /* --- UI ELEMENTS --- */
        #top-bar {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column; /* Deƒüi≈üiklik: Level bar i√ßin dikey yapƒ± */
            background: var(--panel-bg);
            border-bottom: 2px solid var(--accent);
            padding: 10px 20px;
            box-sizing: border-box;
            z-index: 10;
            border-radius: 0 0 15px 15px;
        }

        .header-row {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }

        .score-group { display: flex; gap: 15px; }
        
        .score-card {
            text-align: center;
        }

        .label { font-size: 8px; color: var(--accent); margin-bottom: 4px; opacity: 0.8; letter-spacing: 1px; }
        .value { font-size: 14px; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }

        #settings-btn {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--accent);
            color: var(--accent);
            font-size: 14px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 0 5px rgba(0, 243, 255, 0.2);
        }

        /* Level Bar */
        .xp-container {
            width: 100%; height: 6px; background: #333; margin-top: 10px; border-radius: 3px; position: relative; overflow: hidden;
        }
        .xp-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent), #fff);
            transition: width 0.3s;
        }
        .level-text { font-size: 10px; color: #fff; margin-top: 5px; text-align: center; font-family: 'Rajdhani', sans-serif; font-weight: bold; }

        /* --- GAME CONTAINER --- */
        #game-container {
            position: relative;
            margin: 5px 0;
            flex-grow: 1; /* Mobilde alan kaplasƒ±n */
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; max-width: 500px;
        }

        canvas#gameCanvas {
            background-color: rgba(21, 21, 30, 0.8);
            border-radius: 16px;
            display: block;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
        }

        /* --- SKILLS BAR --- */
        .skills-container {
            width: 100%; max-width: 500px;
            display: flex; justify-content: space-around;
            padding: 10px; box-sizing: border-box;
            z-index: 10;
        }

        .skill-btn {
            background: rgba(20,20,30,0.9);
            border: 1px solid #444;
            color: #fff;
            padding: 10px;
            width: 45%;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            font-family: 'Rajdhani', sans-serif;
            transition: 0.2s;
            position: relative;
            overflow: hidden;
        }
        .skill-btn.active { border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }
        .skill-btn.smash-active { border-color: var(--danger); box-shadow: 0 0 15px var(--danger); }
        .skill-btn:active { transform: scale(0.95); }
        
        .skill-icon { font-size: 18px; margin-bottom: 2px; }
        .skill-name { font-weight: bold; font-size: 14px; }
        .skill-cost { font-size: 10px; color: var(--energy-col); font-weight: bold; }

        /* --- MODAL --- */
        #settings-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px);
            z-index: 100; display: none; justify-content: center; align-items: center;
        }
        #settings-modal.active { display: flex; }

        .modal-content {
            background: #15151e; padding: 30px; border-radius: 20px;
            border: 1px solid var(--accent); width: 85%; max-width: 340px; text-align: center;
        }
        .modal-title { margin-bottom: 25px; color: var(--accent); font-size: 20px; }
        .setting-row { margin-bottom: 20px; text-align: left; font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #ddd; }
        
        .close-btn {
            background: var(--accent); border: none; padding: 15px 40px;
            color: #050508; font-family: 'Press Start 2P', cursive; font-size: 12px;
            border-radius: 8px; cursor: pointer; margin-top: 10px;
        }

        .dev-link {
            display: block; margin-top: 20px; font-size: 10px; color: #888; text-decoration: none;
            font-family: 'Press Start 2P'; border-bottom: 1px dashed #444; padding-bottom: 5px;
        }
        .dev-link:hover { color: var(--accent); border-color: var(--accent); }

        /* --- GAME OVER --- */
        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(13, 13, 18, 0.95); border-radius: 16px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #game-over.active { opacity: 1; pointer-events: all; }

        .float-msg {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #ffd700; text-shadow: 2px 2px 0 #000;
            pointer-events: none; opacity: 0; transition: 0.5s; z-index: 60; white-space: nowrap;
        }
        .float-msg.anim { animation: popUp 1s forwards; }

        @keyframes popUp {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -100%) scale(1); opacity: 0; }
        }

        /* SEO HIDDEN TEXT */
        .seo-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    </style>
</head>
<body>

    <div class="seo-hidden">
        <h1>Neon Block Blast - Zeka ve Strateji Oyunu</h1>
        <p>En iyi blok yerle≈ütirme oyunu. Tetris benzeri mekanikler, yetenek sistemi (Reroll, Smash), level atlama sistemi ve muhte≈üem neon grafikler. @frkhnci tarafƒ±ndan geli≈ütirildi. √úcretsiz oyna.</p>
    </div>

    <canvas id="bg-canvas"></canvas>

    <div id="top-bar">
        <div class="header-row">
            <div class="score-group">
                <div class="score-card">
                    <div class="label">PUAN</div>
                    <div class="value" id="score">0</div>
                </div>
                <div class="score-card">
                    <div class="label">REKOR</div>
                    <div class="value" id="high-score">0</div>
                </div>
            </div>
            
            <div style="text-align:right">
                <div class="label" style="color:var(--energy-col)">ENERJƒ∞: <span id="energy-val">0</span></div>
            </div>

            <button id="settings-btn" onclick="toggleSettings()">AYAR</button>
        </div>
        
        <div class="xp-container">
            <div class="xp-fill" id="xp-bar"></div>
        </div>
        <div class="level-text">LEVEL <span id="level-val">1</span></div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="floating-text" class="float-msg">LEVEL UP!</div>
        
        <div id="game-over">
            <h1 style="color:var(--danger); margin-bottom:10px; text-shadow: 0 0 20px var(--danger);">Bƒ∞TTƒ∞</h1>
            <p style="color:#aaa; font-size:10px;">TOPLAM SKOR</p>
            <p id="final-score" style="color:#fff; font-size:24px; margin:15px 0;">0</p>
            <button class="close-btn" onclick="game.restart()">TEKRAR OYNA</button>
        </div>
    </div>

    <div class="skills-container">
        <div class="skill-btn" id="btn-reroll" onclick="game.useSkill('reroll')">
            <div class="skill-icon">‚ôªÔ∏è</div>
            <div class="skill-name">REROLL</div>
            <div class="skill-cost">50 ENERJƒ∞</div>
        </div>
        <div class="skill-btn" id="btn-smash" onclick="game.useSkill('smash')">
            <div class="skill-icon">üî®</div>
            <div class="skill-name">SMASH</div>
            <div class="skill-cost">100 ENERJƒ∞</div>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-title">AYARLAR</div>
            
            <div class="setting-row">
                <div style="display:flex; justify-content:space-between;">
                    <span>M√úZƒ∞K</span>
                    <span id="music-status" style="color:var(--accent)">KAPALI</span>
                </div>
                <input type="checkbox" id="chk-music" onchange="toggleMusic(this.checked)" style="margin-top:10px; transform:scale(1.5);">
            </div>

            <div class="setting-row">
                <div style="display:flex; justify-content:space-between;">
                    <span>DOKUNMA AYARI</span>
                </div>
                <input type="range" id="rng-offset" min="0" max="150" value="100" style="width:100%; margin-top:10px;" oninput="updateOffset(this.value)">
                <div style="font-size:10px; color:#666; margin-top:5px;">Parmaƒüƒ±n bloƒüu kapatmamasƒ± i√ßin.</div>
            </div>

            <button class="close-btn" onclick="toggleSettings()">DEVAM ET</button>
            
            <a href="https://www.instagram.com/frkhnci/?hl=tr" target="_blank" class="dev-link">Developer: @frkhnci</a>
        </div>
    </div>

<script>
/**
 * --- RHYTHMIC TECHNO AUDIO ENGINE (Code Generated) ---
 */
const AudioEngine = {
    ctx: null, vol: 0.5, isPlaying: false, interval: null, beat: 0,
    init: function() {
        if(this.ctx) return;
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext();
    },
    toggle: function(on) {
        this.init(); this.isPlaying = on;
        if(on) {
            if(this.ctx.state === 'suspended') this.ctx.resume();
            this.interval = setInterval(() => this.playBeat(), 500); // 120 BPM
            document.getElementById('music-status').innerText = "A√áIK";
        } else {
            clearInterval(this.interval);
            document.getElementById('music-status').innerText = "KAPALI";
        }
    },
    playBeat: function() {
        const t = this.ctx.currentTime;
        // Kick
        this.tone(100, 'sine', 0.1, t, 0.6);
        this.tone(60, 'square', 0.1, t, 0.3);
        // Hi-hat offbeat
        if(this.beat%2!==0) this.noise(t, 0.05);
        // Bassline
        const bass = [55, 65, 55, 73];
        this.tone(bass[this.beat%4], 'sawtooth', 0.2, t+0.25, 0.2);
        this.beat++;
    },
    tone: function(f, type, d, t, v) {
        const o=this.ctx.createOscillator(), g=this.ctx.createGain();
        o.type=type; o.frequency.value=f;
        o.connect(g); g.connect(this.ctx.destination);
        o.start(t); o.stop(t+d);
        g.gain.setValueAtTime(v*this.vol, t);
        g.gain.exponentialRampToValueAtTime(0.01, t+d);
    },
    noise: function(t, d) {
        const b=this.ctx.createBuffer(1,this.ctx.sampleRate*d,this.ctx.sampleRate), dt=b.getChannelData(0);
        for(let i=0;i<dt.length;i++) dt[i]=Math.random()*2-1;
        const s=this.ctx.createBufferSource(), g=this.ctx.createGain();
        s.buffer=b; s.connect(g); g.connect(this.ctx.destination);
        g.gain.value=this.vol*0.1; s.start(t);
    }
};

const SFX = {
    ctx: null,
    init: function() { 
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        this.ctx = new AudioContext(); 
    },
    play: function(type) {
        if(!this.ctx) this.init();
        if(this.ctx.state === 'suspended') this.ctx.resume();
        const t = this.ctx.currentTime;
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);

        if(type==='pickup') {
            o.frequency.setValueAtTime(300,t); o.frequency.linearRampToValueAtTime(500,t+0.1);
            g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.1);
            o.start(t); o.stop(t+0.1);
        } else if(type==='drop') {
            o.frequency.setValueAtTime(200,t); o.frequency.exponentialRampToValueAtTime(50,t+0.15);
            g.gain.setValueAtTime(0.2,t); g.gain.linearRampToValueAtTime(0,t+0.15);
            o.start(t); o.stop(t+0.15);
        } else if(type==='clear') {
            o.type='square'; o.frequency.setValueAtTime(600,t); o.frequency.linearRampToValueAtTime(1200,t+0.1);
            g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.15);
            o.start(t); o.stop(t+0.15);
        } else if(type==='gameover') {
            o.type='sawtooth'; o.frequency.setValueAtTime(400,t); o.frequency.linearRampToValueAtTime(20,t+1.5);
            g.gain.setValueAtTime(0.3,t); g.gain.linearRampToValueAtTime(0,t+1.5);
            o.start(t); o.stop(t+1.5);
        } else if(type==='skill') {
            o.type='square'; o.frequency.setValueAtTime(800,t); o.frequency.linearRampToValueAtTime(400,t+0.2);
            g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.2);
            o.start(t); o.stop(t+0.2);
        }
    }
};

/* GLOBAL VARS */
let touchOffset = 100;
let isPaused = false;

function toggleSettings() {
    const m = document.getElementById('settings-modal');
    m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    isPaused = m.style.display === 'flex';
    if(!isPaused) game.loop();
}
function toggleMusic(chk) { AudioEngine.toggle(chk); }
function updateOffset(val) { touchOffset = parseInt(val); }

/* --- BACKGROUND FX --- */
const bgC=document.getElementById('bg-canvas'), bgCtx=bgC.getContext('2d');
let bgOff=0;
function drawBg() {
    if(isPaused) return;
    bgC.width=window.innerWidth; bgC.height=window.innerHeight;
    bgCtx.clearRect(0,0,bgC.width,bgC.height);
    bgCtx.strokeStyle='rgba(0, 243, 255, 0.05)';
    bgOff=(bgOff+0.5)%40;
    bgCtx.beginPath();
    for(let x=0; x<bgC.width; x+=40) { bgCtx.moveTo(x,0); bgCtx.lineTo(x,bgC.height); }
    for(let y=bgOff; y<bgC.height; y+=40) { bgCtx.moveTo(0,y); bgCtx.lineTo(bgC.width,y); }
    bgCtx.stroke();
    requestAnimationFrame(drawBg);
}
drawBg();

/* --- GAME LOGIC --- */
const CONSTANTS = { GRID: 8, COLORS: ['#FF0055', '#00FF99', '#00CCFF', '#FFFF00', '#FF6600', '#CC33FF'] };
const BG_COLORS = ['#050508', '#1a0b1a', '#0b1a1a', '#1a1a0b', '#000000'];

const SHAPES = [
    [[1]], [[1,1]], [[1,1,1]], [[1,1,1,1]], 
    [[1,1],[1,1]], [[1,1,1],[0,1,0]], 
    [[1,1,1],[1,0,0]], [[1,1,0],[0,1,1]], 
    [[1,1],[1,0]]
];

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.grid = Array(8).fill().map(()=>Array(8).fill(null));
        this.hand = [null,null,null];
        this.score = 0; this.highScore = localStorage.getItem('nbb_v5_hs')||0;
        this.level = 1; this.xp = 0; this.energy = 0;
        this.dragged = null; this.dragOff = {x:0,y:0};
        this.smashMode = false;
        
        this.resize();
        window.addEventListener('resize', ()=>{this.resize(); this.reposHand();});
        this.bindEvents();
        this.updateUI();
        this.spawnShapes();
        this.loop();
    }

    resize() {
        // Mobil uyumlu boyutlandƒ±rma
        const maxW = Math.min(window.innerWidth - 20, 500);
        // Header(100) + Skills(80) + Padding(20) = ~200px
        const availH = window.innerHeight - 200;
        
        let w = maxW;
        let h = w * 1.4;
        if(h > availH) { h = availH; w = h / 1.4; }

        this.canvas.width = w; this.canvas.height = h;
        this.gap = 4; const pad=12;
        const gw = w - (pad*2);
        this.cellSize = (gw - (7*this.gap)) / 8;
        this.gridX = pad; this.gridY = 20;
    }

    reposHand() {
        const zw = this.canvas.width/3;
        const hy = this.canvas.height - (this.cellSize*2.5);
        this.hand.forEach((h,i)=>{ if(h && h!==this.dragged){ h.x=zw*i+zw/2; h.y=hy; } });
    }

    changeBg() {
        document.body.style.backgroundColor = BG_COLORS[(this.level-1)%BG_COLORS.length];
    }

    spawnShapes() {
        const zw=this.canvas.width/3, hy=this.canvas.height-(this.cellSize*2.5);
        for(let i=0;i<3;i++) {
            if(!this.hand[i]) {
                const m = SHAPES[Math.floor(Math.random()*SHAPES.length)];
                this.hand[i] = {
                    data:m, color:CONSTANTS.COLORS[Math.floor(Math.random()*CONSTANTS.COLORS.length)],
                    x:zw*i+zw/2, y:hy, scale:0.6, idx:i
                };
            }
        }
        this.reposHand();
        if(this.checkGO()) setTimeout(()=>this.triggerGO(),500);
    }

    // --- SKILLS ---
    useSkill(type) {
        if(type==='reroll') {
            if(this.energy>=50) {
                this.energy-=50; this.hand=[null,null,null]; this.spawnShapes();
                this.floatText("REROLL!"); SFX.play('skill');
            }
        } else if(type==='smash') {
            if(this.energy>=100) {
                this.smashMode = !this.smashMode;
                const btn = document.getElementById('btn-smash');
                if(this.smashMode) { btn.classList.add('smash-active'); this.floatText("SMASH MODE!"); }
                else { btn.classList.remove('smash-active'); }
            }
        }
        this.updateUI();
    }

    execSmash(r,c) {
        if(this.grid[r][c]) {
            this.grid[r][c] = null;
            this.energy -= 100;
            this.smashMode = false;
            document.getElementById('btn-smash').classList.remove('smash-active');
            SFX.play('gameover'); // Par√ßalanma sesi
            this.floatText("SMASHED!");
            this.updateUI();
        }
    }

    // --- LOOP ---
    loop() {
        if(!isPaused) { this.draw(); requestAnimationFrame(()=>this.loop()); }
    }

    draw() {
        this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);
        
        // Grid
        const tw = (8*(this.cellSize+this.gap))-this.gap;
        this.ctx.fillStyle = 'rgba(30,30,40,0.8)';
        this.ctx.fillRect(this.gridX-5, this.gridY-5, tw+10, tw+10); // Simple rect

        for(let r=0;r<8;r++) for(let c=0;c<8;c++) {
            const x=this.gridX+c*(this.cellSize+this.gap);
            const y=this.gridY+r*(this.cellSize+this.gap);
            this.ctx.fillStyle = this.smashMode ? 'rgba(255,0,0,0.1)' : '#22222b';
            this.ctx.fillRect(x,y,this.cellSize,this.cellSize);
            if(this.grid[r][c]) this.drawBlock(x,y,this.cellSize,this.grid[r][c]);
        }

        // Ghost
        if(this.dragged && !this.smashMode) {
            const p = this.getGridPos(this.dragged.x, this.dragged.y);
            if(p && this.canPlace(this.dragged.data, p.r, p.c)) {
                this.ctx.globalAlpha=0.3;
                this.drawShapeGrid(this.dragged.data, p.r, p.c, this.dragged.color);
                this.ctx.globalAlpha=1;
            }
        }

        this.hand.forEach(h=>{ if(h && h!==this.dragged) this.drawShapeFree(h); });
        if(this.dragged) this.drawShapeFree(this.dragged);
    }

    drawBlock(x,y,s,c) {
        this.ctx.fillStyle=c; this.ctx.fillRect(x,y,s,s);
        this.ctx.shadowColor=c; this.ctx.shadowBlur=10; 
        this.ctx.fillStyle='rgba(255,255,255,0.4)'; this.ctx.fillRect(x+3,y+3,s/3,s/3);
        this.ctx.shadowBlur=0;
    }

    drawShapeFree(s) {
        const sc=s===this.dragged?1:s.scale, m=s.data;
        const w=m[0].length*this.cellSize*sc+(m[0].length-1)*this.gap*sc;
        const h=m.length*this.cellSize*sc+(m.length-1)*this.gap*sc;
        const sx=s.x-w/2, sy=s.y-h/2;
        for(let r=0;r<m.length;r++) for(let c=0;c<m[0].length;c++) if(m[r][c])
            this.drawBlock(sx+c*(this.cellSize*sc+this.gap*sc), sy+r*(this.cellSize*sc+this.gap*sc), this.cellSize*sc, s.color);
    }
    
    drawShapeGrid(m,gr,gc,col) {
        for(let r=0;r<m.length;r++) for(let c=0;c<m[0].length;c++) if(m[r][c]) {
            const x=this.gridX+(gc+c)*(this.cellSize+this.gap);
            const y=this.gridY+(gr+r)*(this.cellSize+this.gap);
            this.drawBlock(x,y,this.cellSize,col);
        }
    }

    // --- INPUT ---
    bindEvents() {
        const getP=(e)=>{
            const r=this.canvas.getBoundingClientRect();
            const t=e.touches?e.touches[0]:e;
            return {x:t.clientX-r.left, y:t.clientY-r.top};
        };
        const start=(e)=>{
            if(isPaused) return;
            AudioEngine.init(); SFX.init();
            const p=getP(e);
            
            if(this.smashMode) {
                const gp=this.getGridPos(p.x, p.y);
                if(gp) this.execSmash(gp.r, gp.c);
                return;
            }

            for(let i=0;i<3;i++) if(this.hand[i]) {
                const dx=p.x-this.hand[i].x, dy=p.y-this.hand[i].y;
                if(dx*dx+dy*dy<5000) {
                    this.dragged=this.hand[i]; this.hand[i]=null;
                    this.dragOff.y=e.touches?touchOffset:0;
                    this.dragged.x=p.x; this.dragged.y=p.y-this.dragOff.y;
                    SFX.play('pickup');
                    break;
                }
            }
        };
        const move=(e)=>{
            if(!this.dragged) return;
            e.preventDefault();
            const p=getP(e);
            this.dragged.x=p.x; this.dragged.y=p.y-this.dragOff.y;
        };
        const end=()=>{
            if(!this.dragged) return;
            const gp=this.getGridPos(this.dragged.x, this.dragged.y);
            if(gp && this.canPlace(this.dragged.data, gp.r, gp.c)) {
                this.place(this.dragged, gp.r, gp.c);
            } else {
                SFX.play('drop');
                this.hand[this.dragged.idx]=this.dragged; this.reposHand();
            }
            this.dragged=null;
        };
        this.canvas.addEventListener('mousedown',start); window.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
        this.canvas.addEventListener('touchstart',start,{passive:false}); this.canvas.addEventListener('touchmove',move,{passive:false}); window.addEventListener('touchend',end);
    }

    getGridPos(x,y) {
        const ref=this.dragged?this.dragged.data:[[1]]; // smash mode check
        const w=ref[0].length*this.cellSize, h=ref.length*this.cellSize;
        const c=Math.round(((x-w/2)-this.gridX)/(this.cellSize+this.gap));
        const r=Math.round(((y-h/2)-this.gridY)/(this.cellSize+this.gap));
        if(c>=0&&c<8&&r>=0&&r<8) return {r,c};
        return null;
    }

    canPlace(m,r,c) {
        for(let i=0;i<m.length;i++) for(let j=0;j<m[0].length;j++) if(m[i][j]) {
            if(r+i>=8 || c+j>=8 || this.grid[r+i][c+j]) return false;
        }
        return true;
    }

    place(s,r,c) {
        const m=s.data; let cnt=0;
        for(let i=0;i<m.length;i++) for(let j=0;j<m[0].length;j++) if(m[i][j]) {
            this.grid[r+i][c+j]=s.color; cnt++;
        }
        SFX.play('drop');
        this.addScore(cnt*10); 
        this.energy = Math.min(100, this.energy+cnt); // Her blok 1 enerji
        
        this.checkLines();
        if(this.hand.every(x=>x===null)) setTimeout(()=>this.spawnShapes(),200);
        else if(this.checkGO()) setTimeout(()=>this.triggerGO(),500);
        this.updateUI();
    }

    checkLines() {
        let lines=[];
        for(let r=0;r<8;r++) if(this.grid[r].every(x=>x)) lines.push({t:'r',i:r});
        for(let c=0;c<8;c++) { let f=true; for(let r=0;r<8;r++) if(!this.grid[r][c]) f=false; if(f) lines.push({t:'c',i:c}); }
        
        if(lines.length>0) {
            SFX.play('clear');
            this.energy = Math.min(100, this.energy + lines.length*10); // Hat ba≈üƒ±na enerji
            this.addScore(lines.length*100*lines.length);
            
            lines.forEach(l=>{
                if(l.t==='r') for(let c=0;c<8;c++) this.grid[l.i][c]=null;
                else for(let r=0;r<8;r++) this.grid[r][l.i]=null;
            });
            
            const msg = lines.length>1 ? lines.length+"X COMBO!" : "TEMƒ∞Z!";
            this.floatText(msg);
        }
    }

    addScore(pts) {
        this.score+=pts; this.xp+=pts;
        if(this.score>this.highScore) { this.highScore=this.score; localStorage.setItem('nbb_v5_hs',this.highScore); }
        // Level Logic: 500 XP
        if(this.xp >= 500) {
            this.xp -= 500; this.level++;
            this.floatText("LEVEL UP!"); SFX.play('skill');
            this.changeBg();
        }
        this.updateUI();
    }

    checkGO() {
        for(let i=0;i<3;i++) if(this.hand[i]) {
            for(let r=0;r<8;r++) for(let c=0;c<8;c++) if(this.canPlace(this.hand[i].data,r,c)) return false;
        }
        return this.hand.every(x=>x===null)?false:true;
    }

    triggerGO() {
        SFX.play('gameover');
        document.getElementById('final-score').innerText=this.score;
        document.getElementById('game-over').classList.add('active');
    }

    restart() {
        this.grid=Array(8).fill().map(()=>Array(8).fill(null));
        this.hand=[null,null,null];
        this.score=0; this.level=1; this.xp=0; this.energy=0;
        this.updateUI(); this.changeBg();
        document.getElementById('game-over').classList.remove('active');
        this.spawnShapes();
    }
    
    floatText(txt) {
        const el = document.getElementById('floating-text');
        el.innerText = txt;
        el.classList.remove('anim'); void el.offsetWidth; el.classList.add('anim');
    }

    updateUI() {
        document.getElementById('score').innerText = this.score;
        document.getElementById('high-score').innerText = this.highScore;
        document.getElementById('level-val').innerText = this.level;
        document.getElementById('energy-val').innerText = this.energy + '%';
        document.getElementById('xp-bar').style.width = (this.xp/500)*100 + '%';
        
        // Skill buttons visual state
        document.getElementById('btn-reroll').style.opacity = this.energy>=50 ? 1 : 0.5;
        document.getElementById('btn-smash').style.opacity = this.energy>=100 ? 1 : 0.5;
    }
}

window.onload = () => window.game = new Game();
</script>
</body>
</html>
